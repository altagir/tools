#!/bin/bash

LOCKFILE=/tmp/mining.lock
if [ -e ${LOCKFILE} ] && kill -0 `cat ${LOCKFILE}`; then
    echo "already running"
    exit
fi

# make sure the lockfile is removed when we exit and then claim it
trap "rm -f ${LOCKFILE}; exit" INT TERM EXIT
echo $$ > ${LOCKFILE}



################################################################################
### SCRIPT_DIR is the location the script
SCRIPT_DIR="`dirname \"$0\"`"                 # relative
SCRIPT_DIR="`( cd \"$SCRIPT_DIR\" && pwd )`"  # absolutized and normalized
if [ -z "$SCRIPT_DIR" ] ; then
    # error; for some reason, the path is not accessible
    # to the script (e.g. permissions re-evaled after suid)
    exit 1  # fail
fi

################################################################################


source $SCRIPT_DIR/FUNCTIONS

settings_load
if [ "$RESTART_IF_IDLE" = "0" ]; then
	exit 0
fi


PID=$(ps -ef | awk '/[m]iner/{print $2}')
if [ "$PID" = "" ]; then
        echo "no mining detectedi, restarting system"
	systemctl restart mining
	exit 0
else
	UP=$(ps -o etime= -p $PID)
	UP="$(echo -e "${UP}" | sed -e 's/^[[:space:]]*//')"	
	DIFF=`expr substr ${UP} 1 5`
	if [[ "$DIFF" = "00:"* ]] || [[ "$DIFF" = "01:"* ]]; then
		echo "miner started less than 2 mn ago, skipping check"
		exit 0
	fi
        #echo "Mining uptime: $UP"
fi


FAIL_COUNT=0


GPU=0
while [ "$GPU" -lt "$NB_GPUS" ]; do

	GPUINFO=`nvidia-smi -i $GPU --query-gpu=index,name,utilization.gpu,temperature.gpu --format=csv,noheader`

	if [[ $GPUINFO = *"Unknown"* ]]; then
		echo "Rebooting due to unknown GPU state $GPUINFO"
		reboot
       		exit 0
	elif [[ $GPUINFO = *"ERR"* ]]; then
		echo "Rebooting due to ERROR in GPU state $GPUINFO"
		reboot
       		exit 0
	fi

	UTIL=$(echo $GPUINFO | cut -f3 -d"," | cut -f2 -d" ")
	if (($UTIL < $IDLE_GPU)); then
		let FAIL_COUNT=FAIL_COUNT+1 
		echo "GPU$GPU IDLE $GPUINFO"
	#else
	#	echo "GPU$GPU OK"
	fi

	let GPU=GPU+1 

done

# if 2 fail. restart
if [ $FAIL_COUNT -ge 2 ]; then

	state=$($SCRIPT_DIR/ms -nofancy)$(tail -n 20 /var/log/mining.log 2> /dev/null)$(nvidia-smi)
	mail "$EMAIL_NOTIF" -s "$HOSTNAME : ISSUE ($FAIL_COUNT/$NB_GPUS), restarting miner" <<< $state

	### restart ccminer
	echo "restarting mining, fail=$FAIL_COUNT"
	systemctl restart mining
fi

rm -f ${LOCKFILE}


